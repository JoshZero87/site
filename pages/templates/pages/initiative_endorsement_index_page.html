{% extends "pages/base_page.html" %}

{% load pages_tags static wagtailcore_tags wagtailimages_tags %}

{% block meta_og %}
    <meta property="og:locale" content="en_US" />
    <meta property="og:title" content="{% firstof page.seo_title page.title "Our Revolution" %}" />
    <meta property="og:description" content="{% firstof page.search_description "The next step for Bernie Sanders' movement is a new group called Our Revolution, which will fight to transform America and advance the progressive agenda that we believe in." %}" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Our Revolution" />
    {% if request.GET.category and request.GET.category != 'all' %}
        {% with "dist/img/meta/"|add:request.GET.category|add:".png" as social_image %}
            <meta property="og:image" content="{% base_url %}{% static social_image %}" />
        {% endwith %}
    {% elif page.social_image %}
        {% image page.social_image original as social_image_url %}
        <meta property="og:image" content="{{ social_image_url.url }}" />
    {% else %}
        <meta property="og:image" content="{% or_meta_image_url %}" />
    {% endif %}
{% endblock %}

{% block meta_twitter %}
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:title" content="{% firstof page.seo_title page.title "Our Revolution" %}"/>
    <meta name="twitter:description" content="{% firstof page.search_description "The next step for Bernie Sanders' movement is a new group called Our Revolution, which will fight to transform America and advance the progressive agenda that we believe in." %}" />
    <meta name="twitter:site" content="@OurRevolution"/>
    {% if request.GET.category and request.GET.category != 'all' %}
        {% with "dist/img/meta/"|add:request.GET.category|add:".png" as social_image %}
            <meta name="twitter:image" content="{% base_url %}{% static social_image %}" />
        {% endwith %}
    {% elif page.social_image %}
        {% image page.social_image original as social_image_url %}
        <meta name="twitter:image" content="{{ social_image_url.url }}" />
    {% else %}
        <meta name="twitter:image" content="{% or_meta_image_url %}" />
    {% endif %}
{% endblock %}

{% block content %}

<div class="container-fluid">
  <div class="row">
	<div class="page-heading page-heading--full clearfix">
	  <div class="container">
		<h1>Our Initiatives</h1>
	  </div>
	</div>
  </div>
</div>

<div class="container">

  <div class="clearfix">
    <div class="mt10 pull-right">
      {% include "partials/endorsements-nav.html" %}
    </div>
  </div>

  <div class="page-sub-nav filter clearfix">
				<div class="form-inline pull-left">
					<div class="form-group">
						<label for="fuzzy-search" class="sr-only">Filter By:</label><input type="search" class="filter__search fuzzy-search" id="fuzzy-search" onkeyup="fuzzySearch(this);" placeholder="Search by Name or State...">
					</div>
				</div>

				<div class="filter__sort pull-right">
					Sort By:
					<div class="btn-group sort-buttons" role="group" aria-label="Sort By:">
						<button type="button" class="btn btn-default0" sort-by="state">State <span class="caret"></span></button>
						<button type="button" class="btn btn-default0" sort-by="category">Category <span class="caret"></span></button>
					</div>
				</div>
  </div>

			<div class="col-md-3">
				<div class="toggle-nav hidden-md hidden-lg" id="toggle-nav">Ballot Initiatives <i class="glyphicon glyphicon-menu-hamburger toggle-nav__icon"></i></div>
				<ul class="nav nav-pills nav-stacked issues__nav" id="initiatives-nav">
					<li role="presentation" category="all" class="active">
						<a href="#"><span class="icon labor-2"></span>All Initiatives</span></a>
					</li>

          {% comment "Leave out animal rights category" %}
					<li role="presentation" category="animal-rights">
						<a href="#">
              <span class="icon animal-rights"></span>Animal Rights
            </a>
					</li>
          {% endcomment %}

					<li role="presentation" category="corporate-tax">
						<a href="#"><span class="icon corporate-tax"></span>Corporate Tax</span></a>
					</li>
					<li role="presentation" category="death-penalty">
						<a href="#"><span class="icon death-penalty"></span>Death Penalty</span></a>
					</li>
					<li role="presentation" category="education">
						<a href="#"><span class="icon education"></span>Education</span></a>
					</li>
					<li role="presentation" category="election-reform">
						<a href="#"><span class="icon election-reform"></span>Election Reform</span></a>
					</li>
					<li role="presentation" category="environment">
						<a href="#"><span class="icon environment"></span>Environment</span></a>
					</li>
					<li role="presentation" category="health-care">
						<a href="#"><span class="icon health-care"></span>Health Care</span></a>
					</li>
					<li role="presentation" category="labor">
						<a href="#"><span class="icon labor"></span>Labor</span></a>
					</li>
					<li role="presentation" category="marijuana">
						<a href="#"><span class="icon marijuana"></span>Marijuana</span></a>
					</li>
					<li role="presentation" category="minimum-wage">
						<a href="#"><span class="icon minimum-wage"></span>Minimum Wage</span></a>
					</li>
					<li role="presentation" category="money-in-politics">
						<a href="#"><span class="icon money-in-politics"></span>Money in Politics</span></a>
					</li>
				</ul>
			</div>

			<div class="col-md-9" id="initiatives-list">
				<div class="no-result text-center pa20 br3 f5f5f5-bg"><h3 class="mt0 mb0">No Matching Initiatives Found</h3></div>

				<ul class="card-list third list">

          {% for initiative in initiatives %}
          {% with initiative.initiativeendorsementpage as initiative_page %}
          {% include "partials/initiative_card.html" %}
          {% endwith %}
          {% endfor %}

				</ul>

        <p>Our team is working hard to fully research the upcoming elections and find the best progressive causes for us to support. Please check back soon to see our complete new slate of ballot initiatives.</p>

        {% endorsement_process_url as link_url %}
        <p>
          <strong>To learn more about Our Revolution's endorsement process,
          <a href="{{link_url}}">click here</a>.</strong>
        </p>

        <div class="mb20 mt20">
          <a href="{% results_url %}"
          class="btn btn-block btn-primary ls2 uppercase">
            View 2018 Election Results
          </a>

          <a href="{% results_2017_url %}"
          class="btn btn-block btn-default ls2 uppercase">
            View 2017 Election Results
          </a>

          <a href="{% results_2016_url %}"
          class="btn btn-block btn-default ls2 uppercase">
            View 2016 Election Results
          </a>
        </div>

			</div>
</div>

{% endblock %}


{% block footer_scripts %}

<script src="//cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>

<script>
  var sortingBy = "featured";
  var sortingAsc = true;

  // Functions

  function fuzzySearch(e) {
    initiativesList.search(e.value);
  }

  function sort(sortBy) {
  	if (sortingBy === sortBy) {
  	  if (sortingAsc) {
  		initiativesList.sort(sortBy, { order: 'desc'});
  		sortingAsc = false;
  	  }
  	  else {
  		initiativesList.sort(sortBy, { order: 'asc'});
  		sortingAsc = true;
  	  }
  	} else {
  	  initiativesList.sort(sortBy, { order: 'asc'});
  	  sortingAsc = true;
  	}
  	sortingBy = sortBy;
  }

  function filter(category) {
  	if (category && category != 'all') {
  	  initiativesList.filter(function (item) {

  		if(category == item._values.category.trim())
  		  return true;
  		else
  		  return false;
  	  });

  	} else {
  	  initiativesList.filter();
  	}
  }

  function getParameterByName(name, url) {
  	if (!url) {
  	  url = window.location.href;
  	}
  	name = name.replace(/[\[\]]/g, "\\$&");
  	var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
  		results = regex.exec(url);
  	if (!results) return null;
  	if (!results[2]) return '';
  	return decodeURIComponent(results[2].replace(/\+/g, " "));
  }

  function isCategory(category) {
  	var nav = $('.issues__nav');
  	if (nav.find("[category='" + category + "']").length > 0)
  	  return true;
  	else
  	  return false;
  }

  function setActive(category) {
  	var nav = $('.issues__nav');
  	// set active state
  	nav.find('li').each(function () {
  	  $(this).removeClass("active");
  	});
  	nav.find("[category='" + category + "']").toggleClass("active");
  	updateUrl(category);
  }

  function updateUrl(category) {
  	if (category)
  	  window.history.pushState('ballot-initiatives', 'Our Revolution - Initiatives', '/ballot-initiatives?category=' + category);
  	else
  	  window.history.pushState('ballot-initiatives', 'Our Revolution - Initiatives', '/ballot-initiatives');
  }

  var options = {
	  valueNames: [
  		'state',
  		'name',
  		'title',
  		'vote',
  		'category',
  		{ name: 'featured', data: 'is-featured' }
	  ]
  };
  var initiativesList = new List('initiatives-list', options);
  var self = this;

  // Filter list by URL category
  if (getParameterByName('category')) {
  	var category = getParameterByName('category');
  	if (isCategory(category)) {
  	  setActive(category);
  	  self.filter(category);
  	}
  }

  $("#initiatives-nav").on("click", function(e) {
  	e.preventDefault();

  	if($("#initiatives-nav").hasClass("expanded")) {
  	  $("#initiatives-nav").removeClass("expanded");
  	  $('.toggle-nav__icon').removeClass('glyphicon-remove');
  	  $('.toggle-nav__icon').addClass('glyphicon-menu-hamburger');
  	}

  	$("#fuzzy-search").val("");
  	initiativesList.search();
  	var category = $(e.target).closest("li").attr("category") || false;

  	if (category) {
  	  setActive(category);
  	  self.filter(category);
  	}

  });

  initiativesList.on("updated", function(list) {
  	if (list.matchingItems.length > 0) {
  	  $('.no-result').hide();
  	} else {
  	  $('.no-result').show();
  	}
  });

  $(".sort-buttons").on("click", function(e) {
  	var btn = $(e.target).closest(".btn");
  	var sortByData = btn.attr("sort-by");
  	sort(sortByData);

  	if (sortingBy == sortByData) {

  	  $(".sort-buttons .btn").each(function(e) {
    		$(this).removeClass("active");
    		$(this).removeClass("asc");
    		$(this).removeClass("desc");
  	  });

  	  btn.toggleClass("active");

  	  if (sortingAsc) {
    		btn.addClass("asc");
    		btn.removeClass("desc");
  	  } else {
    		btn.addClass("desc");
    		btn.removeClass("asc");
  	  }

  	}

  });

</script>

<script>
  $(document).ready(function() {
  	$('.toggle-nav__icon').on('click touchstart', function(e) {

  	  e.preventDefault();
  	  $('.issues__nav').toggleClass('expanded');

  	  if($('.toggle-nav__icon').hasClass('glyphicon-menu-hamburger')) {
    		$('.toggle-nav__icon').removeClass('glyphicon-menu-hamburger');
    		$('.toggle-nav__icon').addClass('glyphicon-remove');

  	  } else {
    		$('.toggle-nav__icon').removeClass('glyphicon-remove');
    		$('.toggle-nav__icon').addClass('glyphicon-menu-hamburger');
  	  }

  	});
  });
</script>

{% endblock %}
